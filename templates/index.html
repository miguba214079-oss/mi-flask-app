<!DOCTYPE html>
<!-- Define que el documento usa la versi贸n HTML5 -->

<html lang="en">
<!-- Idioma principal del documento -->

<head>
    <meta charset="UTF-8">
    <!-- Permite caracteres como tildes, 帽, emojis, etc. -->

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Hace que el dise帽o sea responsivo en m贸viles -->

    <title>Document</title>
    <!-- T铆tulo por defecto (pero ser谩 sobrescrito con Jinja) -->
</head>

<body>
<!-- templates/index.html -->
<!-- Este archivo representa la p谩gina principal del sitio -->

{% extends 'base.html' %}
<!-- Esta plantilla hereda estructura, navbar y estilos de base.html -->

{% block title %}Inicio{% endblock %}
<!-- Define el t铆tulo de la pesta帽a del navegador -->

{% block content %}
<!-- Inicio del contenido principal que se mostrar谩 dentro de base.html -->

<h2>Bienvenido, {{ user.username }}</h2>
<!-- Muestra el nombre de usuario del que inici贸 sesi贸n -->

<a href="{{ url_for('new_post') }}" class="btn btn-primary mb-3">
    Nueva publicaci贸n
</a>
<!-- Bot贸n para crear nueva publicaci贸n -->

{% for post in posts %}
<!-- Itera sobre todas las publicaciones enviadas desde Flask -->

<div class="card mb-4">
    <!-- Cada publicaci贸n es una tarjeta Bootstrap -->

    <div class="card-body">
        <!-- Contenido del post -->

        <p>{{ post.content }}</p>
        <!-- Texto de la publicaci贸n -->

        {% if post.media_url %}
        <!-- Si la publicaci贸n contiene un archivo multimedia -->

            {% if post.media_type == 'image' %}
            <!-- Si es una imagen -->

                <img src="{{ post.media_url }}" alt="Media" style="max-width: 400px;">

            {% elif post.media_type == 'video' %}
            <!-- Si es un video -->

                <video controls width="400">
                    <source src="{{ post.media_url }}" type="video/mp4">
                    Tu navegador no soporta video HTML5.
                </video>

            {% elif post.media_type == 'audio' %}
            <!-- Si es audio -->

                <audio controls>
                    <source src="{{ post.media_url }}" type="audio/mpeg">
                    Tu navegador no soporta audio HTML5.
                </audio>

            {% endif %}
        {% endif %}

        <small class="text-muted" 
               style="background: rgba(255, 255, 255, 0.762);">
            Publicado por {{ post.author.username }}
            el {{ post.timestamp.strftime('%d/%m/%Y %H:%M') }}
        </small>
        <!-- Muestra autor y fecha, formateada -->

        {% if user.id == post.user_id %}
        <!-- Si el post pertenece al usuario actual, mostrar opciones -->

            <div class="mt-2">
                <a href="{{ url_for('edit_post', post_id=post.id) }}"
                   class="btn btn-sm btn-outline-primary">
                    Editar
                </a>

                <form action="{{ url_for('delete_post', post_id=post.id) }}"
                      method="POST" style="display:inline;">
                    <!-- Formulario para eliminar publicaci贸n -->

                    <button type="submit"
                            class="btn btn-sm btn-outline-danger"
                            onclick="return confirm('驴Eliminar esta publicaci贸n?');">
                        Eliminar
                    </button>
                </form>
            </div>

        {% endif %}

        <!-- ====================== REACCIONES ========================== -->

        <div class="mt-3">
            <strong>Reacciones:</strong>

            <span id="reactions-count-{{ post.id }}">
                <!-- Aqu铆 se muestran las reacciones contadas -->

                {% set reaction_counts = {} %}
                <!-- Diccionario temporal para contar emojis -->

                {% for reaction in post.reactions %}
                    <!-- Itera cada reacci贸n del post -->

                    {% set reaction_counts = 
                        reaction_counts.update({
                            reaction.emoji: (reaction_counts.get(reaction.emoji, 0) + 1)
                        }) 
                        or reaction_counts %}
                    <!-- Suma 1 al emoji correspondiente -->
                {% endfor %}

                {% for emoji, count in reaction_counts.items() %}
                    <!-- Muestra cada emoji con su n煤mero -->

                    {{ emoji }} {{ count }}&nbsp;
                {% endfor %}
            </span>
        </div>

        <!-- Botones de reacci贸n -->
        <div class="mt-2">
            {% for emoji in ['', 'わ', '', '', '', ''] %}
                <button class="btn btn-sm btn-outline-secondary reaction-btn"
                        data-post-id="{{ post.id }}"
                        data-emoji="{{ emoji }}">
                    {{ emoji }}
                </button>
            {% endfor %}
        </div>

        <!-- ====================== COMENTARIOS ========================== -->

        <div class="mt-3">
            <strong>Comentarios:</strong>

            <ul class="list-unstyled">
                {% for comment in post.comments %}
                <!-- Listado de comentarios -->

                    <li>
                        <small>
                            <strong>{{ comment.user.username }}</strong> dijo:
                        </small>

                        <p>{{ comment.content }}</p>
                        <!-- Texto del comentario -->

                        <small class="text-muted" 
                               style="background: rgba(255, 255, 255, 0.762);">
                               {{ comment.timestamp.strftime('%d/%m/%Y %H:%M') }}
                        </small>
                    </li>

                {% else %}
                <!-- Si no hay comentarios -->

                    <li><em>No hay comentarios a煤n.</em></li>

                {% endfor %}
            </ul>
        </div>

        <!-- Formulario para agregar un nuevo comentario -->
        <form action="{{ url_for('new_comment') }}" method="POST" class="mt-3">
            <input type="hidden" name="post_id" value="{{ post.id }}">
            <!-- Para saber a qu茅 publicaci贸n pertenece el comentario -->

            <div class="input-group">
                <input type="text" name="content" class="form-control"
                       placeholder="Escribe un comentario..." required>

                <button class="btn btn-primary" type="submit">Comentar</button>
            </div>
        </form>
    </div>
</div>

{% else %}
<!-- Si no hay posts -->

<p>No hay publicaciones a煤n.</p>

{% endfor %}

<!-- ====================== JS PARA LAS REACCIONES ========================== -->

<script>
document.querySelectorAll('.reaction-btn').forEach(button => {
    // Selecciona todos los botones de reacci贸n

    button.addEventListener('click', () => {
        // Evento clic para cada bot贸n

        const postId = button.getAttribute('data-post-id');
        // Obtiene el ID del post

        const emoji = button.getAttribute('data-emoji');
        // Obtiene qu茅 emoji se presion贸

        fetch('{{ url_for("reaction") }}', {
            // Env铆a petici贸n al backend Flask

            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ post_id: postId, emoji: emoji })
            // Manda JSON con la info necesaria para registrar la reacci贸n
        })
        .then(response => response.json())
        // Convierte la respuesta a JSON

        .then(data => {
            // Maneja la respuesta del servidor

            if (data.counts) {
                // Si devuelve los conteos actualizados

                let countsHtml = '';

                for (const [e, c] of Object.entries(data.counts)) {
                    // Recorre emojis y sus conteos
                    countsHtml += `${e} ${c} &nbsp;`;
                }

                document.getElementById('reactions-count-' + postId)
                        .innerHTML = countsHtml;
                // Actualiza lo que se muestra en la p谩gina
            }
        });
    });
});
</script>

{% endblock %}
<!-- Cierra el bloque de contenido principal -->

</body>
</html>
